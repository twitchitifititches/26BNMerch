name: Monthly Merch Report
on:
  schedule:
    - cron: '0 0 1 * *' # Runs at 12:00 AM on the 1st of every month
  workflow_dispatch: # Allows you to run it manually for testing

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate CSV & Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          MERCH_CHAT_ID: ${{ secrets.MERCHANDISER_CHAT_ID }}
        run: |
          python - <<EOF
          import json
          import csv
          import requests
          from datetime import datetime

          # 1. Load the history from your inventory file
          with open('inventory.json', 'r') as f:
              db = json.load(f)
          
          orders = db.get('orders', [])
          report_name = f"26th_BN_Report_{datetime.now().strftime('%Y_%m')}.csv"

          # 2. Create the spreadsheet
          with open(report_name, 'w', newline='') as f:
              writer = csv.writer(f)
              writer.writerow(['Date', 'Customer', 'Items', 'Total Price'])
              for o in orders:
                  items_list = ", ".join([f"{i['name']} (x{i['quantity']})" for i in o['items']])
                  writer.writerow([o.get('timestamp', 'N/A'), o['customer'], items_list, o['total']])

          # 3. Send the file to the Merchandiser via your Bot
          url = f"https://api.telegram.org/bot{os.getenv('BOT_TOKEN')}/sendDocument"
          with open(report_name, 'rb') as doc:
              requests.post(url, data={'chat_id': os.getenv('MERCH_CHAT_ID'), 'caption': f"Monthly Report for {datetime.now().strftime('%B %Y')}"}, files={'document': doc})
          EOF
